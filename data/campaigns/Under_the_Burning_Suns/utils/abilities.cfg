#textdomain wesnoth-help

# These are all direct clones of the mainline healing abilities, except that
# they are set to exclude units suffering from dehydration. Dehydration is only
# delayed by healers, so they must not actually heal a dehydrated unit any
# hitpoints.
#
# The ability macros go into wesnoth textdomain since the strings are identical
# to their core counterparts, but the special notes belong to wesnoth-utbs.

#define UTBS_ABILITY_HEALS
    [heals]
        value=4
        id=healing
        affect_allies=yes
        name= _ "heals +4"
        female_name= _ "female^heals +4"
        description=  _ "Allows the unit to heal adjacent allied units at the beginning of our turn.

A unit cared for by this healer may heal up to 4 HP per turn, or stop poison from taking effect for that turn.
A poisoned unit cannot be cured of its poison by a healer, and must seek the care of a village or a unit that can cure."
        affect_self=no
        poison=slowed
        [affect_adjacent]
            [filter]
                [not]
                    status=dehydration_slowed_by_healer
                [/not]
            [/filter]
        [/affect_adjacent]
    [/heals]
#enddef

#define UTBS_ABILITY_EXTRA_HEAL
    [heals]
        value=8
        id=healing
        affect_allies=yes
        name= _ "heals +8"
        female_name= _ "female^heals +8"
        description= _ "This unit combines herbal remedies with magic to heal units more quickly than is normally possible on the battlefield.

A unit cared for by this healer may heal up to 8 HP per turn, or stop poison from taking effect for that turn.
A poisoned unit cannot be cured of its poison by a healer, and must seek the care of a village or a unit that can cure."
        affect_self=no
        poison=slowed
        [affect_adjacent]
            [filter]
                [not]
                    status=dehydration_slowed_by_healer
                [/not]
            [/filter]
        [/affect_adjacent]
    [/heals]
#enddef

#define UTBS_ABILITY_CURES
    {ABILITY_UNPOISON}
    {UTBS_ABILITY_EXTRA_HEAL}
#enddef

#textdomain wesnoth-utbs

#define SPECIAL_NOTES_UTBS_HEALS
_" This unit is capable of basic healing and slowing dehydration."#enddef

#define SPECIAL_NOTES_UTBS_CURES
_" This unit is capable of healing those around it, slowing dehydration, and curing them of poison."#enddef

# This is the Teaching ability owned by Garak

#define ABILITY_TEACHING
    [dummy]
        id=teaching
        name= _ "teaching"
        description= _ "At the start of every turn, this unit redistributes its experience points to all the units of the same side adjacent to it. If no suitable unit is adjacent, its experience just goes back to zero."
    [/dummy]
#enddef

#define WEAPON_SPECIAL_SHOCK
    # Canned definition of the Shock ability to be included in a
    # [specials] clause.
    [attacks]
        id=shock
        name= _ "shock"
        name_inactive= _ "shock"
        description= _ "When this attack is used on offense, the opponent will retaliate with one less strike than normally, to a minimum of one strike."
        description_inactive= _ "When this attack is used on offense, the opponent will retaliate with one less strike than normally, to a minimum of one strike."
        sub=1
        active_on=offense
        apply_to=opponent
        [filter_base_value]
            greater_than=1
        [/filter_base_value]
    [/attacks]
#enddef

#define ABILITY_FORMATION
    [dummy]
        id=formation
        name= _ "formation"
        description= _ "This unit gains a +10% bonus to defense when another unit with the same ability is adjacent to it and the enemy. However, this cannot raise the unit's defense above 70%."
    [/dummy]
#enddef

#define ABILITY_DISENGAGE
    [dummy]
        id=disengage
        name="disengage"
        description="If this unit doesn't move before attacking, it will retain its movement points after the attack."
    [/dummy]
#enddef

#define WEAPON_SPECIAL_DAZE
    [dummy]
        id=daze
        name= _ "daze"
        description= _ "When hit with this attack, an enemy suffers a 10% penalty both to their defense and chance to hit for one turn, except for magical attacks."
    [/dummy]
#enddef

#define SPECIAL_NOTES_DAZE
_"."#enddef

#define ABILITY_DISENGAGE_EVENTS
    [event]
        name=attack end
        first_time_only=no

        [filter]
            ability=disengage

            [not]
                [filter_wml]
                    moves=$this_unit.max_moves
                [/filter_wml]
            [/not]
        [/filter]

        {VARIABLE unit.moves 0}

        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
    [/event]
#enddef

#define DAZE_ALLY_OBJECT FILTER
    [object]
        silent=yes

        [filter]
            {FILTER}
        [/filter]

        [effect]
            apply_to=attack

            [set_specials]
                mode=append

                [chance_to_hit]
                    id=daze_ally
                    name=""
                    description=""
                    add=10
                    [filter_opponent]
                        [filter_wml]
                            [status]
                                dazed=yes
                            [/status]
                        [/filter_wml]
                    [/filter_opponent]
                [/chance_to_hit]
            [/set_specials]
        [/effect]
    [/object]
#enddef

#define DAZE_ENEMY_OBJECT FILTER
    [object]
        silent=yes

        [filter]
            {FILTER}
        [/filter]

        [effect]
            apply_to=attack

            [set_specials]
                mode=append

                [chance_to_hit]
                    id=daze_enemy
                    name=""
                    description=""
                    sub=10
                    [filter_self]
                        [filter_wml]
                            [status]
                                dazed=yes
                            [/status]
                        [/filter_wml]
                    [/filter_self]
                [/chance_to_hit]
            [/set_specials]
        [/effect]
    [/object]
#enddef

#define LACKS_DAZE_ALLY_FILTER
    [not]
        [filter_wml]
            [attack]
                [specials]
                    [chance_to_hit]
                        id=daze_ally
                    [/chance_to_hit]
                [/specials]
            [/attack]
        [/filter_wml]
    [/not]
#enddef

#define WEAPON_SPECIAL_DAZE_EVENTS
    [event]
        id=daze_1
        name=prerecruit,prerecall
        first_time_only=no

        [filter]
            {LACKS_DAZE_ALLY_FILTER}
        [/filter]

        {DAZE_ALLY_OBJECT x,y=$x1,$y1}
    [/event]

    [event]
        id=daze_2
        name=side 1 turn
        first_time_only=no

        [store_unit]
            [filter]
                {LACKS_DAZE_ALLY_FILTER}
            [/filter]

            kill=no
            variable=units_lacking_daze
        [/store_unit]

        {FOREACH units_lacking_daze i}
            {DAZE_ALLY_OBJECT x,y=$units_lacking_daze[$i].x,$units_lacking_daze[$i].y}
        {NEXT i}

        {CLEAR_VARIABLE units_lacking_daze}
    [/event]

    [event]
        id=daze_3
        name=attack
        first_time_only=no

        [filter_second]
            {LACKS_DAZE_ALLY_FILTER}
        [/filter_second]

        {DAZE_ALLY_OBJECT x,y=$x2,$y2}
    [/event]
    
    [event]
        name=attacker hits
        first_time_only=no
        
        [filter_attack]
            special=daze
        [/filter_attack]
        
        [filter_second]
            [not]
                [filter_wml]
                    [status]
                        dazed=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter_second]
        
        {VARIABLE second_unit.status.dazed yes}
        
        [unstore_unit]
            variable=second_unit
            find_vacant=no
            text= _ "dazed"
            red,green,blue=196,196,128
        [/unstore_unit]
        
        {DAZE_ENEMY_OBJECT x,y=$x2,$y2}
    [/event]
#enddef

#define FORMATION_OBJECT UNITVAR
    [object]
        silent=yes

        [filter]
            id=${UNITVAR}.id
        [/filter]

        [effect]
            apply_to=attack

            [set_specials]
                mode=append

                [chance_to_hit]
                    id=formation_enemy_1
                    name=""
                    description=""
                    sub=10
                    [filter_base_value]
                        greater_than=30
                    [/filter_base_value]
                    [filter_opponent]
                        ability=formation
                        
                        [filter_adjacent]
                            ability=formation
                            is_enemy=no
                            count=1
                            
                            [filter_adjacent]
                                id=${UNITVAR}.id
                            [/filter_adjacent]
                        [/filter_adjacent]
                    [/filter_opponent]
                [/chance_to_hit]
                [chance_to_hit]
                    id=formation_enemy_2
                    name=""
                    description=""
                    sub=20
                    [filter_base_value]
                        greater_than=40
                    [/filter_base_value]
                    [filter_opponent]
                        ability=formation
                        
                        [filter_adjacent]
                            ability=formation
                            is_enemy=no
                            count=2
                            
                            [filter_adjacent]
                                id=${UNITVAR}.id
                            [/filter_adjacent]
                        [/filter_adjacent]
                    [/filter_opponent]
                [/chance_to_hit]
            [/set_specials]
        [/effect]
    [/object]
#enddef

#define LACKS_FORMATION_FILTER
    [not]
        side=1
    [/not]
    [not]
        [filter_wml]
            [attack]
                [specials]
                    [chance_to_hit]
                        id=formation_enemy_1
                    [/chance_to_hit]
                [/specials]
            [/attack]
        [/filter_wml]
    [/not]
#enddef

#define ABILITY_FORMATION_EVENTS
    [event]
        id=formation_1
        name=prerecruit,prerecall
        first_time_only=no

        [filter]
            {LACKS_FORMATION_FILTER}
        [/filter]

        {FORMATION_OBJECT unit}
    [/event]

    [event]
        id=formation_2
        name=side 1 turn
        first_time_only=no

        [store_unit]
            [filter]
                {LACKS_FORMATION_FILTER}
            [/filter]

            kill=no
            variable=units_lacking_formation
        [/store_unit]

        {FOREACH units_lacking_formation i}
            {FORMATION_OBJECT units_lacking_formation[$i]}
        {NEXT i}

        {CLEAR_VARIABLE units_lacking_formation}
    [/event]

    [event]
        id=formation_3
        name=attack
        first_time_only=no

        [filter_second]
            {LACKS_FORMATION_FILTER}
        [/filter_second]

        {FORMATION_OBJECT second_unit}
    [/event]
#enddef