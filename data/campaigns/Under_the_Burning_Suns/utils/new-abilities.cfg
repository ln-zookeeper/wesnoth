#define WEAPON_SPECIAL_DAZE
    [dummy]
        id=daze
        name= _ "daze"
        description= _ "When hit with this attack, an enemy suffers a 10% penalty both to their defense and chance to hit for one turn, except for magical attacks."
    [/dummy]
#enddef

#define SPECIAL_NOTES_DAZE
_"."#enddef

#define DAZE_ALLY_OBJECT FILTER
    [object]
        silent=yes

        [filter]
            {FILTER}
        [/filter]

        [effect]
            apply_to=attack

            [set_specials]
                mode=append

                [chance_to_hit]
                    id=daze_ally
                    name=""
                    description=""
                    add=10
                    [filter_opponent]
                        [filter_wml]
                            [status]
                                dazed=yes
                            [/status]
                        [/filter_wml]
                    [/filter_opponent]
                [/chance_to_hit]
            [/set_specials]
        [/effect]
    [/object]
#enddef

#define DAZE_ENEMY_OBJECT FILTER
    [object]
        silent=yes

        [filter]
            {FILTER}
        [/filter]

        [effect]
            apply_to=attack

            [set_specials]
                mode=append

                [chance_to_hit]
                    id=daze_enemy
                    name="asdf"
                    description=""
                    sub=10
                    [filter_self]
                        [filter_wml]
                            [status]
                                dazed=yes
                            [/status]
                        [/filter_wml]
                    [/filter_self]
                [/chance_to_hit]
            [/set_specials]
        [/effect]
    [/object]
#enddef

#define LACKS_DAZE_ALLY_FILTER
    side=1

    [filter_side]
        [allied_with]
            [has_unit]
                id="Li'sar"
            [/has_unit]
        [/allied_with]
    [/filter_side]

    [filter_wml]
        [attack]
            range=melee
        [/attack]
    [/filter_wml]

    [not]
        [filter_wml]
            [attack]
                range=melee
                [specials]
                    [firststrike]
                    [/firststrike]
                [/specials]
            [/attack]
        [/filter_wml]
    [/not]
#enddef

#define WEAPON_SPECIAL_DAZE_EVENTS
    [event]
        id=daze_1
        name=prerecruit,prerecall
        first_time_only=no

        [filter]
            {LACKS_DAZE_ALLY_FILTER}
        [/filter]

        {DAZE_ALLY_OBJECT x,y=$x1,$y1}
    [/event]

    [event]
        id=daze_2
        name=side 1 turn
        first_time_only=no

        [store_unit]
            [filter]
                {LACKS_DAZE_ALLY_FILTER}
            [/filter]

            kill=no
            variable=units_lacking_daze
        [/store_unit]

        {FOREACH units_lacking_daze i}
            {DAZE_ALLY_OBJECT x,y=$units_lacking_daze[$i].x,$units_lacking_daze[$i].y}
        {NEXT i}

        {CLEAR_VARIABLE units_lacking_daze}
    [/event]

    [event]
        id=daze_3
        name=attack
        first_time_only=no

        [filter_second]
            {LACKS_DAZE_ALLY_FILTER}
        [/filter_second]

        {DAZE_ALLY_OBJECT x,y=$x2,$y2}
    [/event]
    
    [event]
        name=attacker hits
        first_time_only=no
        
        [filter_attack]
            special=daze
        [/filter_attack]
        
        [filter_second]
            [not]
                [filter_wml]
                    [status]
                        dazed=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter_second]
        
        {VARIABLE second_unit.status.dazed yes}
        
        [unstore_unit]
            variable=second_unit
            find_vacant=no
            text= _ "dazed"
            red,green,blue=196,196,128
        [/unstore_unit]
        
        {DAZE_ENEMY_OBJECT x,y=$x2,$y2}
    [/event]
#enddef